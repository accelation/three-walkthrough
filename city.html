<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>city</title>
        <script type="text/javascript" src="libs/three.js"></script>
        <script type="text/javascript" src="libs/stats.js"></script>
        <script type="text/javascript" src="libs/dat.gui.js"></script>
        <style>
            body {
                margin: 0;
                overflow: hidden;
            }
        </style>
    </head>
    <body>

        <div id="Stats-output"></div>
        <div id="WebGL-output"></div>

        <script type="text/javascript">

            function init() {
                var stats = initStats();

                var scene = new THREE.Scene();

                var camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 1, 10000);
                camera.position.y = 400;
                camera.position.z = 400;
                camera.position.x = -45 * Math.PI / 180;
                camera.lookAt(new THREE.Vector3(0, 0, 0))
                scene.add(camera);

                var renderer = new THREE.WebGLRenderer({antialias: true});
                renderer.setClearColor(new THREE.Color(0x000000, 1.0));
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.shadowMapEnabled = true;

                document.getElementById("WebGL-output").appendChild(renderer.domElement);

                var step = 0;

                var controls = new function() {
                    this.outputObjects = function() {
                        console.log(scene.children);
                    };
                };
                var gui = new dat.GUI();
                gui.add(controls, 'outputObjects');

                setupWorld();
                render();

                function setupWorld() {
                    var geo = new THREE.PlaneGeometry(2000, 2000, 40, 40);
                    var mat = new THREE.MeshPhongMaterial({color: 0x9db3b5, overdraw: true});
                    var floor = new THREE.Mesh(geo, mat);
                    floor.rotation.x = -0.5 * Math.PI;
                    floor.receiveShadow = true;
                    scene.add(floor);

                    var geometry = new THREE.BoxGeometry(1, 1, 1);
                    geometry.applyMatrix(new THREE.Matrix4().makeTranslation(0, 0.5, 0));
                    var material = new THREE.MeshPhongMaterial({color: 0xcccccc, overdraw: true});

                    var cityGeometry = new THREE.Geometry();
                    for (var i = 0; i < 300; i++) {
                        var building = new THREE.Mesh(geometry.clone());
                        building.position.x = Math.floor(Math.random()*200 - 100) * 4;
                        building.position.z = Math.floor(Math.random()*200 - 100) * 4;
                        building.scale.x = Math.random()*50 + 10;
                        building.scale.y = Math.random()*building.scale.x*8 + 8;
                        building.scale.z = building.scale.x;
                        building.updateMatrix();
                        cityGeometry.merge(building.geometry, building.matrix);
                    }
                    var city = new THREE.Mesh(cityGeometry, material);
                    city.castShadow = true;
                    city.receiveShadow = true;
                    scene.add(city);

                    var light = new THREE.DirectionalLight(0xffffff, 1);
                    light.position.set(500, 1500, 1000);
                    light.castShadow = true;
                    light.shadowMapWidth = 2048;
                    light.shadowMapHeight = 2048;
                    var d = 1000;
				    light.shadowCameraLeft = d;
				    light.shadowCameraRight = -d;
				    light.shadowCameraTop = d;
				    light.shadowCameraBottom = -d;
				    light.shadowCameraFar = 2500;
                    scene.add(light);
                }

                function render() {
                    stats.update();

                    requestAnimationFrame(render);
                    renderer.render(scene, camera);
                }

                function initStats() {
                    var stats = new Stats();

                    stats.setMode(0); // 0: fps, 1: ms

                    // 左上に配置
                    stats.domElement.style.position = 'absolute';
                    stats.domElement.style.left = '0px';
                    stats.domElement.style.top = '0px';

                    document.getElementById("Stats-output").appendChild(stats.domElement);

                    return stats;
                }
            }
            window.onload = init;
        </script>
    </body>
</html>
